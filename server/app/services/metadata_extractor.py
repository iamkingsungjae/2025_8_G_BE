"""LLM 기반 메타데이터 추출기"""
import json
import re
import time
from typing import Dict, Any
from anthropic import Anthropic
import logging

logger = logging.getLogger(__name__)


class MetadataExtractor:
    """LLM으로 검색 쿼리에서 메타데이터 추출"""

    def __init__(self, api_key: str):
        """
        Args:
            api_key: Anthropic API 키
        """
        if not api_key:
            logger.error("[MetadataExtractor] API 키가 비어있습니다!")
        elif len(api_key) < 50:
            logger.warning(f"[MetadataExtractor] API 키가 너무 짧습니다 (길이: {len(api_key)})")
        
        self.client = Anthropic(api_key=api_key)
        self.model = "claude-haiku-4-5-20251001"  # ⭐ haiku 사용  

    def extract(self, query: str) -> Dict[str, Any]:
        """
        자연어 쿼리에서 구조화된 메타데이터 추출 (다중 값/범위 지원)

        Args:
            query: 검색 쿼리 (예: "서울 강남구 27세 기혼 남자")

        Returns:
            메타데이터 딕셔너리 (예: {"지역": "서울", "지역구": "강남구", "나이": 27, "연령대": "20대", "성별": "남", "결혼여부": "기혼"})
        """
        extract_start = time.time()
        
        prompt = f"""당신은 자연어 질의에서 메타데이터를 추출하는 전문가입니다.

자연어 질의를 분석하여 모든 정보를 메타데이터로 추출하세요.

=== 추출 규칙 ===

1. **지역 관련 정보는 모두 "지역" 키로 추출** (매우 중요!)
   - 국내 지역: "서울", "경기", "부산" 등 → "지역" 키 사용
   - 지역구: "강남구", "서초구", "양산시" 등 → "지역구" 키로 별도 추출
   - 해외 관련: "해외", "외국", "국외", "외국인", "해외 거주" 등 → "지역": "해외"
   - "거주지", "거주", "사는 곳" 등의 키 사용 금지
   - 반드시 "지역" 또는 "지역구" 키만 사용할 것

2. **다중 값은 리스트로 표현**
   - "서울, 경기" → "지역": ["서울", "경기"]
   - "서울 또는 경기" → "지역": ["서울", "경기"]
   - "20대, 30대" → "연령대": ["20대", "30대"]

3. **나이와 연령대 모두 추출**
   - "27세" → "나이": 27, "연령대": "20대"
   - "35세" → "나이": 35, "연령대": "30대"
   - 연령대만 있으면: "20대" → "연령대": "20대"
   - ⭐⭐⭐주의사항
   - "20명", "30개" 와 같은 문장 끝에 있는건 인원수 추출이다. 연령대로 추출하면 안된다.

4. **범위는 연령대 리스트로 변환**
   - "10~20세" → "연령대": ["10대", "20대"]
   - "20대~30대" → "연령대": ["20대", "30대"]
   - **"40세 이하" → "연령대": ["10대", "20대", "30대", "40대"]** ⭐
   - **"40대 이하" → "연령대": ["10대", "20대", "30대", "40대"]** ⭐

5. **성별 정규화**
   - "남성", "남자", "남" → "남자"
   - "여성", "여자", "여" → "여자"

6. **결혼여부 추출** (⭐⭐⭐ 가장 중요! 절대 지켜야 함!)
   - 반드시 "결혼여부" 키만 사용 (다른 키 사용 절대 금지!)
   - "기혼", "결혼한", "결혼한 사람", "결혼함" → "결혼여부": "기혼"
   - "미혼", "미혼인", "결혼 안한" → "결혼여부": "미혼"
   - ⚠️ 절대 사용 금지 키: "결혼상태", "결혼상황", "혼인", "결혼" (이런 키 쓰면 안됨!)

7. **자녀수/가족수 추출** (⭐⭐⭐ 매우 중요!)
   - 반드시 "자녀수", "가족수" 키만 사용 (다른 키 사용 절대 금지!)
   - "자녀 2명" → "자녀수": 2
   - "가족 3명", "가족 구성 3명" → "가족수": 3
   - **"혼자 사는", "1인 가구", "독거", "혼자 거주" → "가족수": 1** ⭐
   - **"2인 가구" → "가족수": 2** ⭐
   - ⚠️ 절대 사용 금지 키: "가구형태", "가구유형", "거주형태" (이런 키 쓰면 안됨!)

8. **학력 추출**
   - "고졸", "고등학교 졸업" → "학력": "고등학교 졸업 이하"
   - "대학생", "대학 재학" → "학력": "대학교 재학"
   - "대졸", "대학교 졸업" → "학력": "대학교 졸업"
   - "대학원", "석사", "박사" → "학력": "대학원 재학/졸업 이상"

9. **직업 추출** (⭐⭐⭐ 매우 중요: 15개 보기 중 하나로 정확히 매핑)
   - **전문직**: 의사, 간호사, 변호사, 회계사, 예술가, 종교인, 엔지니어, 프로그래머, 기술사
   - **교직**: 교수, 교사, 강사
   - **경영/관리직**: 사장, 임원, 대기업 간부, 고위 공무원, 경영직, 관리직
   - **사무직**: 사무직, 은행원, 공무원, 군인, 경찰, 소방관
   - **자영업**: 제조업, 건설업, 도소매업, 운수업, 무역업, 서비스업 경영 (⭐ 건설업은 자영업!)
   - **판매직**: 매장 판매직, 세일즈, 보험설계사, 텔레마케터, 영업, 보험판매, 세일즈맨, 도매업, 소매업, 부동산, 행상, 노점상
   - **서비스직**: 미용, 통신, 안내, 요식업 직원, 요식업
   - **생산/노무직**: 차량운전자, 현장직, 생산직 (⭐ 건설 현장직만 해당, 건설업 경영은 자영업)
   - **기능직**: 제빵사, 목수, 전기공, 정비사, 배관공
   - **농업/임업/축산업/광업/수산업**
   - **임대업**
   - **중/고등학생**
   - **대학생/대학원생**
   - **전업주부**
   - **퇴직/연금생활자**

   중요한 구분:
   - "건설업 경영", "건설업에서 일하는", "건설업 종사" → "자영업"
   - "건설 현장", "건설 노무자", "건설 일용직" → "생산/노무직"

9.5. **직무 추출** (⭐⭐⭐ 매우 중요: 21개 보기 중 하나로 정확히 매핑)
   ⚠️ **주의**: 다음 키워드들은 **무조건 직무**로 추출! 직업이 아님!
   - IT, 프로그래밍, 개발자
   - 디자인, 디자이너, 그래픽, 웹디자인, UI/UX
   - 마케팅, 영업, 판매, 세일즈
   - 경영, 인사, 총무, 재무, 회계, 경리
   - 금융, 보험, 증권
   - 게임, 모바일, 인터넷, 통신
   - 기획, 홍보, 광고, 상담

   **21개 보기:**
   - **경영•인사•총무•사무**: 경영, 인사, 총무, 일반 사무, 비서
   - **재무•회계•경리**: 재무, 회계, 경리, 세무
   - **금융•보험•증권**: 은행, 보험, 증권, 자산관리
   - **마케팅•광고•홍보•조사**: 마케팅, 광고, 홍보, 시장조사
   - **무역•영업•판매•매장관리**: 무역, 영업, 판매, 매장관리, 세일즈
   - **고객상담•TM**: 고객상담, 텔레마케팅, 콜센터
   - **전문직•법률•인문사회•임원**
   - **의료•간호•보건•복지**
   - **교육•교사•강사•교직원**
   - **방송•언론**
   - **문화•스포츠**: 문화기획
   - **서비스•여행•숙박•음식•미용•보안**: 미용, 호텔, 경비
   - **유통•물류•운송•운전**: 물류, 배송, 운전
   - **디자인**: 그래픽디자인, 제품디자인, 웹디자인, UI/UX
   - **인터넷•통신**: 통신, 네트워크, 서버
   - **IT**: 개발, 프로그래밍, 소프트웨어
   - **모바일**: 모바일 앱 개발, 모바일 서비스
   - **게임**: 게임 개발, 게임 기획
   - **전자•기계•기술•화학•연구개발**
   - **건설•건축•토목•환경**: 건축설계, 토목, 환경
   - **생산•정비•기능•노무**

10. **모호한 표현 해석**
   - "젊은층", "청년" → "연령대": ["20대", "30대"]
   - "중년층", "장년" → "연령대": ["40대", "50대"]
   - "MZ세대" → "연령대": ["20대", "30대"]

11. **전국/전체는 빈 값으로 처리**
   - "전국" → 지역 필드 생성하지 않음

12. **수도권 특별 처리**
   - "수도권" → "지역": ["서울", "경기", "인천"]

19. **인원수 추출** (⭐⭐⭐ 매우 중요!)
   - "10명", "20명", "5명" → "인원수": 10, 20, 5
   - "10개", "20개" → "인원수": 10, 20
   - "열 명" → "인원수": 10
   - 인원수가 없으면 추출하지 않음
   - 반드시 숫자(int)로 추출

14. **자동차 정보 추출** (⭐ 새로 추가!)
   - "타는", "운전하는", "소유한", "보유한" 등의 표현에서 자동차 추출
   - 브랜드와 모델명 함께 추출: "자동차": "브랜드 모델명"
   - 예: "테슬라 사이버트럭 타는" → "자동차": "테슬라 사이버트럭"
   - 예: "현대 소나타" → "자동차": "현대 소나타"
   - 예: "BMW" → "자동차": "BMW"
   - 차량 없음: "차 없는", "자동차 없는" → "자동차": "없음"

15. **휴대폰 정보 추출** (⭐ 새로 추가!)
   - "쓰는", "사용하는", "보유한" 등의 표현에서 휴대폰 추출
   - 브랜드와 모델명 추출: "휴대폰": "브랜드 모델명"
   - 예: "아이폰 쓰는" → "휴대폰": "아이폰"
   - 예: "삼성 갤럭시" → "휴대폰": "삼성 갤럭시"
   - 예: "iPhone 15" → "휴대폰": "iPhone 15"

16. **전자제품 정보 추출** (⭐ 새로 추가!)
   - TV, 냉장고, 세탁기, 에어컨 등
   - "전자제품": "제품명" 또는 "전자제품": ["제품1", "제품2"]
   - 예: "LG TV 사용하는" → "전자제품": "LG TV"

17. **음주 정보 추출** (⭐ 새로 추가!)
   - "술", "음주", "마시는", "먹은", "좋아하는" 등의 표현에서 음주 추출
   - 술 종류와 함께 추출: "음주": "술 종류" 또는 "음주": "경험"
   - 예: "술을 먹은" → "음주": "경험"
   - 예: "술 마시는" → "음주": "경험"
   - 예: "소주 마시는" → "음주": "소주"
   - 예: "맥주 좋아하는" → "음주": "맥주"
   - 여러 종류: "소주, 맥주" → "음주": ["소주", "맥주"]

18. **흡연 정보 추출** (⭐ 새로 추가!)
   - "담배", "흡연", "피우는" 등의 표현에서 흡연 추출
   - "흡연": "경험" 또는 "흡연": "일반담배"
   - 예: "담배 피우는" → "흡연": "일반담배"
   - 예: "흡연하는" → "흡연": "경험"
   - 예: "전자담배" → "흡연": "전자담배"
   - 비흡연: "담배 안 피우는", "비흡연" → "흡연": "없음"
   - "담배 브랜드" → "흡연": "브랜드명"
   - "전자담배", "아이코스" → "흡연": "전자담배"

19. **소득 정보 추출** (⭐ 개인소득, 가구소득 구분!)
   - "가구소득 300만원", "가구소득 300" → "가구소득": 300
   - "개인소득 500만원대", "월급 500" → "개인소득": 500
   - "연봉 6000" → "개인소득": 500 (연봉/12로 월소득 변환)
   - "월 버는 돈 400만원" → "개인소득": 400
   - 숫자만 추출 (단위: 만원)

=== QuickPoll 메타데이터 추출 규칙 ===

20. **QuickPoll - 스트레스 관련 정보 추출** ⭐
   - **스트레스 원인**: "스트레스", "스트레스 받는", "스트레스 느끼는" 표현 감지
     - "업무 / 학업", "출퇴근", "인간관계 (가족, 친구, 직장 등)", "경제적 문제", "건강 문제", "기타"
     - 예: "업무 스트레스 받는" → "스트레스_원인": "업무 / 학업"
     - 예: "출퇴근 스트레스" → "스트레스_원인": "출퇴근"
     - 예: "돈 걱정" → "스트레스_원인": "경제적 문제"
   
   - **스트레스 해소법**: "스트레스 해소", "스트레스 풀기", "해소" 표현 감지
     - "수면", "음식 섭취", "운동", "명상 / 휴식", "마사지 / 스파", "기타"
     - 예: "스트레스를 잠으로 푸는" → "스트레스_해소": "수면"
     - 예: "운동으로 해소" → "스트레스_해소": "운동"
   
   - **이사 스트레스**: "이사", "이사할 때" 표현 감지
     - "비용 부담", "짐 싸고 풀기", "이사업체 선택", "새로운 환경 적응", "기타", "스트레스 받지 않는다"
     - 예: "이사할 때 비용 걱정" → "이사_스트레스": "비용 부담"

21. **QuickPoll - 미용 관련 정보 추출** ⭐
   - **피부 상태 만족도**: "피부", "피부 상태", "만족" 표현 감지
     - "매우 만족한다", "만족한다", "보통이다", "불만족한다", "매우 불만족한다"
     - 예: "피부에 만족하는" → "피부_만족도": "만족한다"
     - 예: "피부가 안좋은" → "피부_만족도": "불만족한다"
   
   - **스킨케어 지출**: "스킨케어", "화장품", "스킨케어 제품" 표현 감지
     - "3만원 미만", "3만원 이상 ~ 5만원 미만", "5만원 이상 ~ 10만원 미만", "10만원 이상 ~ 15만원 미만", "15만원 이상"
     - 예: "한달에 스킨케어 10만원" → "스킨케어_지출": "10만원 이상 ~ 15만원 미만"
   
   - **스킨케어 구매 기준**: "스킨케어 제품", "구매", "고려" 표현 감지
     - "브랜드 명성", "제품 리뷰 및 사용 후기", "성분 및 효과", "가격", "패키지 디자인"
     - 예: "성분 보고 사는" → "스킨케어_구매기준": "성분 및 효과"

22. **QuickPoll - AI서비스 관련 정보 추출** ⭐⭐⭐
   - **AI 챗봇 사용 경험**: "AI", "챗봇", "AI 챗봇", "사용" 표현 감지
     - "ChatGPT", "딥시크", "Gemini (구글)", "Claude (Anthropic)", "Copilot (마이크로소프트)", "HyperCLOVER X (네이버)", "기타", "사용해 본 적 없음"
     - 다중 선택 가능: "AI_챗봇_사용": ["ChatGPT", "딥시크"]
     - 예: "챗GPT 쓰는" → "AI_챗봇_사용": "ChatGPT"
     - 예: "클로드랑 챗GPT" → "AI_챗봇_사용": ["ChatGPT", "Claude (Anthropic)"]
   
   - **주로 사용하는 AI 챗봇**: "주로 사용", "자주 쓰는" 표현 감지
     - "ChatGPT", "딥시크", "Gemini (구글)", "Claude (Anthropic)", "Copilot (마이크로소프트)", "HyperCLOVER X (네이버)", "기타", "사용해 본 적 없음"
     - 예: "주로 챗GPT" → "AI_챗봇_주사용": "ChatGPT"
   
   - **AI 활용 용도**: "활용", "용도", "AI 서비스" 표현 감지
     - "정보 검색 및 질문 해결", "업무 보조(문서작성, 데이터 분석 등)", "학습 및 과제 도움", "번역 및 언어 학습", "창작 활동(글쓰기, 이미지 생성 등)", "개인 비서(일정 관리, 메모 작성 등)", "코딩 및 프로그래밍 도움", "기타"
     - 예: "공부할 때 AI" → "AI_활용용도": "정보 검색 및 학습"
   
   - **AI 서비스 선호도**: "호감", "선호" 표현 감지
     - "ChatGPT", "딥시크"
     - 예: "챗GPT가 더 좋은" → "AI_서비스_선호": "ChatGPT"

   - **AI 활용 분야**: "활용 분야", "AI 사용 분야", "AI 활용 분야" 표현 감지
     - "업무 보조 (문서 작성, 이메일 등)", "학습/공부 보조", "번역이나 외국어 학습", "이미지 생성 또는 디자인 참고", "콘텐츠 제작 (블로그, 영상 기획 등)", "검색/정보 탐색", "기타", "AI 서비스를 사용해본 적 없다"
     - 예: "콘텐츠 제작에 AI" → "AI_활용분야": "콘텐츠 제작 (블로그, 영상 기획 등)"

23. **QuickPoll - 미디어(OTT/앱) 관련 정보 추출** ⭐⭐⭐
   - **OTT 이용 개수**: "OTT", "OTT 서비스", "이용", "구독" 표현 감지
     - "0개", "1개", "2개", "3개", "4개 이상", "이용하지 않는다"
     - 예: "OTT 2개 쓰는" → "OTT_이용개수": "2개"
     - 예: "넷플릭스랑 디즈니플러스" → "OTT_이용개수": "2개"
   
   - **주로 사용하는 앱**: "사용하는 앱", "자주 쓰는 앱", "주로 쓰는 앱" 표현 감지
     - "SNS 앱 (인스타그램, 페이스북, 틱톡 등)", "동영상 스트리밍 앱 (유튜브, 넷플릭스 등)", "메신저 앱 (카카오톡, 문자 등)", "쇼핑/배달 앱 (쿠팡, 배달의민족, 무신사 등)", "금융 앱", "운동/건강 앱", "게임 앱", "기타"
     - 예: "유튜브 많이 보는" → "주사용_앱": "동영상 스트리밍 앱 (유튜브, 넷플릭스 등)"

24. **QuickPoll - 소비 관련 정보 추출** ⭐
   - **기분 좋은 소비**: "소비", "본인을 위한", "기분 좋아지는" 표현 감지
     - "맛있는 음식 먹기", "여행 가기", "옷/패션관련 제품 구매하기", "취미관련 제품 구매하기", "기타"
     - 예: "외식할 때 기분 좋은" → "기분좋은_소비": "맛있는 음식 먹기"
   
   - **빠른 배송 이용 제품**: "빠른 배송", "당일 배송", "새벽 배송" 표현 감지
     - "신선식품(과일, 채소, 육류 등)", "생활용품(생필품, 위생용품 등)", "전자기기 및 가전제품", "패션·뷰티 제품", "빠른 배송 서비스를 이용해 본 적 없다", "기타"
     - 예: "새벽배송으로 채소" → "빠른배송_제품": "신선식품(과일, 채소, 육류 등)"
   
   - **전통시장 방문 빈도**: "전통시장", "방문", "빈도" 표현 감지
     - "일주일에 1회 이상", "2주에 1회 이상", "한달에 1회 이상", "3개월에 1회 이상", "6개월에 1회 이상", "1년에 1회 이상", "전혀 방문하지 않음"
     - 예: "전통시장 주 2회 가는" → "전통시장_방문": "주 2회"
     - 예: "전통시장 안가는" → "전통시장_방문": "전혀 방문하지 않음"
   
   - **선호하는 설 선물**: "설 선물", "선물 유형" 표현 감지
     - "전통 선물 세트(한우, 굴비, 과일 등)", "실용적인 생필품(샴푸, 세제, 식용유 등)", "건강식품(홍삼, 비타민 등)", "백화점 상품권/현금", "선호하는 선물이 없다", "기타"
     - 예: "설날에 상품권" → "설선물_선호": "현금/상품권"
   
   - **캐시백/할인 관심도**: "할인", "캐시백", "멤버십", "포인트" 표현 감지
     - "매우 꼼꼼하게 챙긴다", "자주 쓰는 곳만 챙긴다", "가끔 생각날 때만 챙긴다", "거의 신경쓰지 않는다", "전혀 관심 없다"
     - 예: "할인 많이 챙기는" → "캐시백_관심": "매우 신경 쓴다"
   
   - **최근 가장 많은 지출 영역**: "지출", "가장 많이", "최근" 표현 감지
     - "외식비", "배달비", "옷/쇼핑", "콘서트, 전시 등 문화생활", "기타"
     - 예: "최근에 외식비가 제일 많은" → "최다_지출": "식비"

25. **QuickPoll - 라이프스타일 관련 정보 추출** ⭐
   - **알람 설정 방식**: "알람", "기상", "아침" 표현 감지
     - "여러 개의 알람을 짧은 간격으로 설정해둔다", "한 개만 설정해놓고 바로 일어난다"
     - 예: "알람 여러 개 설정하는" → "알람_방식": "여러 개의 알람을 짧은 간격으로 설정해둔다"
   
   - **혼자 식사 빈도**: "혼자 식사", "혼밥", "외부 식당", "외식" 표현 감지
     - "거의 매일", "주 2~3회 정도", "주 1회 정도", "월 1~2회 정도", "거의 하지 않거나 한 번도 해본 적 없다"
     - 예: "혼밥 자주 하는" → "혼밥_빈도": "주 2~3회 정도"
   
   - **미니멀/맥시멀리스트**: "미니멀", "맥시멀", "라이프스타일" 표현 감지
     - "미니멀리스트(최소한의 물건만 소유)", "맥시멀리스트(다양한 물건을 많이 소유)"
     - 예: "물건 많은" → "라이프스타일": "맥시멀리스트(다양한 물건을 많이 소유)"
   
   - **개인정보보호 습관**: "개인정보", "보호", "보안", "습관" 표현 감지
     - "비밀번호를 주기적으로 바꾼다", "이중 인증(OTP 등)을 설정한다", "의심스러운 링크/앱은 클릭하지 않는다", "공공 와이파이 사용을 자제한다", "개인정보 제공 동의 시 꼼꼼히 읽는다", "따로 실천하는 게 없다", "기타"
     - 다중 선택 가능
     - 예: "비밀번호 자주 바꾸는" → "개인정보보호": "비밀번호를 주기적으로 바꾼다"
   
   - **물건 처리 방법**: "버리기", "아까운 물건", "물건" 표현 감지
     - "업사이클링(재활용) 시도", "중고로 판매", "기부", "그냥 보관", "바로 버린다"
     - 예: "당근마켓에 파는" → "물건처리": "중고로 판매"
   
   - **일회용 비닐봉투 감소 노력**: "일회용", "비닐봉투", "환경" 표현 감지
     - "장바구니나 에코백을 챙긴다", "비닐 대신 종이봉투나 박스를 활용한다", "아예 쇼핑할 때 봉투를 받지 않는다", "편의점이나 마트에서 유료 봉투를 아깝더라도 산다", "따로 노력하고 있지 않다", "기타"
     - 다중 선택 가능
     - 예: "장바구니 쓰는" → "비닐_감소노력": "장바구니나 에코백을 챙긴다"

26. **QuickPoll - 경험 관련 정보 추출** ⭐
   - **초등학생 겨울방학 기억**: "초등학생", "겨울방학", "기억" 표현 감지
     - "가족과 함께 떠난 여행", "겨울방학 숙제를 끝낸 순간", "방학 동안 다녔던 학원이나 특별 활동", "친구들과 보낸 즐거운 시간", "눈썰매, 스키 등 겨울 스포츠", "눈사람 만들기", "기타"
     - 예: "겨울방학에 눈놀이" → "겨울방학_기억": "눈사람 만들기"
   
   - **휴대폰 갤러리 사진**: "휴대폰", "갤러리", "사진", "저장" 표현 감지
     - "셀카/인물 사진", "음식 사진", "풍경/여행 사진", "반려동물 사진", "메모용 캡처/스크린샷", "친구/가족과의 단체 사진", "SNS/인터넷에서 저장한 이미지", "업무/학업 관련 사진(자료, 필기 등)", "기타"
     - 예: "갤러리에 강아지 사진" → "갤러리_사진": "반려동물"
   
   - **효과적인 다이어트 방법**: "다이어트", "효과", "방법" 표현 감지
     - "하루 세 끼를 규칙적으로 소식하기", "간헐적 단식(예: 16시간 공복)", "저탄고지/단백질 위주 식단", "꾸준한 유산소 운동", "헬스장 또는 홈트레이닝", "식욕 억제제 또는 다이어트 보조제 섭취", "없다", "기타"
     - 예: "간헐적 단식으로 빠진" → "다이어트_방법": "간헐적 단식(예: 16시간 공복)"
   
   - **반려동물 경험**: "반려동물", "키우는", "키워본", "강아지", "고양이", "애완동물" 표현 감지
     - "반려동물을 키우는 중이다", "반려동물을 키워본 적이 있다", "반려동물을 키워본 적이 없다"
     - 예: "강아지 키우는" → "반려동물_경험": "키우는 중이다"
     - 예: "예전에 고양이 키웠던" → "반려동물_경험": "키워본 적이 있다"
     
   - **행복한 노년 조건**: "행복", "노년", "조건", "노후" 표현 감지
     - "건강한 몸과 마음", "안정적인 경제력", "가족 또는 친구와의 친밀한 관계", "여가과 취미를 즐길 수 있는 시간과 여유", "사회와의 적절한 연결감"
     - 예: "노후엔 건강이 중요한" → "노년_조건": "건강한 몸과 마음"

27. **QuickPoll - 식습관 관련 정보 추출** ⭐
   - **야식 섭취 방법**: "야식", "먹다", "밤에 먹는" 표현 감지
     - "배달 주문해서 먹는다", "집에서 직접 만들어 먹는다", "직접 사와서 먹는다", "외출해서 식당이나 포장마차 등에서 먹는다", "야식을 거의 먹지 않는다"
     - 예: "밤에 치킨 시켜먹는" → "야식_방법": "배달 주문해서 먹는다"
   
   - **여름철 최애 간식**: "여름", "간식", "최애", "여름철" 표현 감지
     - "제철과일(수박, 참외 등)", "아이스크림", "냉면", "빙수", "없다", "기타"
     - 예: "여름엔 아이스크림" → "여름_간식": "아이스크림"
   
   - **초콜릿 섭취 시기**: "초콜릿", "먹는", "드시다" 표현 감지
     - "스트레스를 받을 때", "기분이 좋을 때", "간식으로 습관처럼", "선물로 받았을 때", "선물 받았을 때", "특별한 날(생일, 발렌타인데이 등)", "거의 먹지 않는다", "기타"
     - 예: "스트레스 받으면 초콜릿" → "초콜릿_섭취": "스트레스 받을 때"

28. **QuickPoll - 여행 관련 정보 추출** ⭐
   - **여행 스타일**: "여행", "스타일" 표현 감지
     - "계획형(여행 전부터 동선, 맛집, 숙소까지 꼼꼼히 준비)", "즉흥형(가서 보고 느끼는 대로 움직이는 걸 선호)", "반반형(큰 틀만 정하고 세부 일정은 현지에서 정함)", "잘 모르겠다"
     - 예: "여행갈 때 계획 세우는" → "여행_스타일": "계획형 (일정 짜고 다니는)"
   
   - **여름 물놀이 선호 장소**: "물놀이", "장소", "선호", "여름철" 표현 감지
     - "워터파크", "계곡", "해변", "물놀이를 좋아하지 않는다", "기타"
     - 예: "여름에 바다 가는" → "물놀이_장소": "바다"
   
   - **해외여행 희망 지역**: "해외여행", "여행", "가고 싶은" 표현 감지
     - "유럽", "동남아", "미국/캐나다", "일본/중국", "기타", "해외여행을 가고싶지 않다"
     - 다중 선택 가능
     - 예: "일본이랑 유럽 가고싶은" → "해외여행_희망": ["일본", "유럽"]

29. **QuickPoll - 계절 관련 정보 추출** ⭐
   - **여름철 걱정거리**: "여름", "걱정", "여름철" 표현 감지
     - "더위와 땀", "피부 트러블", "냉방병", "전기요금 부담", "체력 저하", "휴가 계획 스트레스", "특별히 걱정되는 것이 없다"
     - 예: "여름에 전기요금 걱정" → "여름_걱정": "전기요금 부담"
   
   - **여름철 땀 불편함**: "여름", "땀", "불편", "불편함" 표현 감지
     - "옷이 젖거나 얼룩지는 것이 신경쓰인다", "땀 냄새가 걱정된다", "메이크업이 무너진다", "머리나 두피가 금방 기름진다", "피부 트러블이 생긴다", "다른 사람의 땀 냄새가 불쾌하다", "특별히 불편한 점이 없다"
     - 다중 선택 가능
     - 예: "여름에 옷 젖는게 싫은" → "땀_불편함": "옷이 젖거나 얼룩지는 것이 신경쓰인다"
   
   - **여름 패션 필수템**: "여름", "패션", "필수템", "포기할 수 없는" 표현 감지
     - "민소매", "얇은 긴팔 셔츠", "반바지", "선글라스", "샌들/슬리퍼", "린넨셔츠", "쿨토시/쿨스카프", "기타"
     - 예: "여름에 선글라스 필수" → "여름_패션필수템": "선글라스"
   
   - **비 올 때 대처법**: "비", "우산", "없을 때", "대처" 표현 감지
     - "그냥 비를 맞고 간다", "편의점에서 우산을 산다", "근처 비를 피할 수 있는 곳으로 뛰어간다", "가족/친구 등 주변지인에게 연락한다", "기타"
     - 예: "비오면 편의점 우산" → "비_대처": "편의점에서 우산을 산다"

30. **QuickPoll - 건강 관련 정보 추출** ⭐
   - **체력 관리 활동**: "체력", "관리", "활동", "운동" 표현 감지
     - "헬스", "홈트레이닝", "요가/필라테스", "달리기/걷기", "자전거 타기", "스포츠(축구, 배드민턴 등)", "수영", "등산", "기타", "체력관리를 위해 하고 있는 활동이 없다"
     - 다중 선택 가능
     - 예: "헬스 다니는" → "체력관리": "헬스"
     - 예: "조깅하는" → "체력관리": "달리기/걷기"

=== 예시 ===

입력: "서울 강남구 27세 기혼 남자"
출력:
{{
    "지역": "서울",
    "지역구": "강남구",
    "나이": 27,
    "연령대": "20대",
    "결혼여부": "기혼",
    "성별": "남자"
}}

입력: "전문직에서 일하는 사람"
출력:
{{
    "직업": "전문직"
}}

입력: "서울 20대 10명"
출력:
{{
    "지역": "서울",
    "연령대": "20대",
    "인원수": 10
}}

입력: "테슬라 사이버트럭 타는 패널"
출력:
{{
    "자동차": "테슬라 사이버트럭"
}}

입력: "아이폰 쓰는 30대"
출력:
{{
    "휴대폰": "아이폰",
    "연령대": "30대"
}}

입력: "넷플릭스 보는 서울 20대 남자"
출력:
{{
    "지역": "서울",
    "연령대": "20대",
    "성별": "남자",
    "OTT_이용개수": "1개"
}}

입력: "챗GPT 쓰고 전통시장 주 2회 가는 30대"
출력:
{{
    "연령대": "30대",
    "AI_챗봇_사용": "ChatGPT",
    "전통시장_방문": "주 2회"
}}

입력: "스트레스 받을 때 운동하고 혼밥 자주 하는"
출력:
{{
    "스트레스_해소": "운동",
    "혼밥_빈도": "주 3~4회"
}}

입력: "강아지 키우고 헬스 다니는 여자"
출력:
{{
    "성별": "여자",
    "반려동물_경험": "키우는 중이다",
    "체력관리": "헬스"
}}

질의: {query}

⚠️⚠️⚠️ 필수 주의사항:
- IT, 개발, 디자인, 마케팅, 영업, 경영, 회계 등은 **무조건 직무**!
- 직업은 15개 보기 중 하나로 정확히 매핑!
- 직무는 21개 보기 중 하나로 정확히 매핑!
- 자동차, 휴대폰, 전자제품, 음주, 흡연도 추출!
- 건설업 = 자영업 (건설업 경영)
- 건설 현장 = 생산/노무직 (건설 현장직)
- 결혼 관련 정보는 반드시 "결혼여부" 키만 사용!
- 가족/가구 관련 정보는 반드시 "가족수" 키만 사용!
- "혼자 사는", "1인 가구", "독거" 등은 모두 "가족수": 1로 변환!
- "XX세 이하"는 해당 연령대까지 모든 연령대를 리스트로 반환
- **검색 결과 개수를 의미하는 숫자 + "명"/"개"는 반드시 "인원수" 키로 추출!** ⭐⭐⭐
- "인원수"는 정수(integer)로 반환 (예: 10, 5, 20)
- QuickPoll 키에 언더스코어(_)가 있는가? (예: "스트레스_원인", "AI_챗봇_사용")

**출력 전 체크리스트:**
□ 모든 키 이름이 규칙대로인가?
□ 결혼여부 값이 "기혼" 또는 "미혼"인가?
□ 성별 값이 "남자" 또는 "여자"인가?
□ 직업이 15개 보기 중 하나인가?
□ 직무가 21개 보기 중 하나인가?
□ QuickPoll 키에 언더스코어(_)가 있는가?

JSON만 반환하세요. 다른 설명은 하지 마세요.
"""

        try:
            # API 키 유효성 검사
            if not self.client or not hasattr(self.client, 'api_key') or not self.client.api_key:
                logger.warning("[메타데이터 추출] Anthropic API 키가 설정되지 않았습니다. 빈 메타데이터 반환")
                return {}
            
            # 실제 사용되는 API 키 확인
            actual_api_key = getattr(self.client, 'api_key', None)
            if not actual_api_key:
                logger.error("[메타데이터 추출] 클라이언트에 API 키가 없습니다!")
                return {}
            
            llm_call_start = time.time()
            try:
                response = self.client.messages.create(
                    model=self.model,
                    max_tokens=2048,  # ⭐ 노트북과 동일: 2048
                    temperature=0.0,
                    messages=[{"role": "user", "content": prompt}],
                    timeout=30.0  # 30초 타임아웃
                )
                text = response.content[0].text
            except Exception as llm_error:
                llm_call_time = time.time() - llm_call_start
                logger.error(f"[메타데이터 추출] Anthropic API 호출 실패: {llm_call_time:.2f}초, 에러: {llm_error}")
                raise
            
            # JSON 파싱 (코드블록 제거)
            if '```json' in text:
                json_text = text.split('```json')[1].split('```')[0].strip()
            elif '```' in text:
                json_text = text.split('```')[1].strip()
            else:
                json_text = text.strip()
            
            try:
                metadata = json.loads(json_text)
            except json.JSONDecodeError as json_err:
                logger.warning(f"[메타데이터 추출] JSON 파싱 실패: {json_err}, 원본 텍스트: {json_text[:200]}")
                # 빈 JSON이나 잘못된 형식인 경우 빈 딕셔너리 반환
                metadata = {}
            
            if not metadata:
                logger.warning(f"[메타데이터 추출] LLM이 빈 메타데이터를 반환했습니다. 원본 응답: {text[:300]}")
            
            # ===== 후처리: 키 이름 및 값 정규화 =====
            
            # 1. 지역 키 정규화
            if "거주지" in metadata and "지역" not in metadata:
                metadata["지역"] = metadata.pop("거주지")
            if "거주" in metadata and "지역" not in metadata:
                metadata["지역"] = metadata.pop("거주")

            # 2. 결혼여부 키 정규화
            marriage_keys = ["결혼상태", "결혼상황", "혼인", "혼인여부", "결혼"]
            for key in marriage_keys:
                if key in metadata and "결혼여부" not in metadata:
                    metadata["결혼여부"] = metadata.pop(key)
                    break

            # 3. 결혼여부 값 정규화
            if "결혼여부" in metadata:
                marriage = metadata["결혼여부"]
                if isinstance(marriage, str):
                    if marriage in ["결혼함", "결혼", "결혼한", "기혼자", "유부남", "유부녀"]:
                        metadata["결혼여부"] = "기혼"
                    elif marriage in ["미혼인", "결혼 안함", "미혼자"]:
                        metadata["결혼여부"] = "미혼"

            # 4. 가족수 키 정규화
            household_keys = ["가구형태", "가구유형", "거주형태", "가구구성"]
            for key in household_keys:
                if key in metadata and "가족수" not in metadata:
                    value = metadata.pop(key)
                    if isinstance(value, str):
                        match = re.search(r'(\d+)인', value)
                        if match:
                            metadata["가족수"] = int(match.group(1))
                    break

            # 5. ⭐ 직업 정규화 (15개 보기로 매핑)
            if "직업" in metadata:
                job = metadata["직업"]
                job_normalized = self._normalize_job(job)
                if job_normalized != job:
                    metadata["직업"] = job_normalized

            # 6. 성별 정규화
            if "성별" in metadata:
                gender = metadata["성별"]
                if isinstance(gender, str):
                    if gender in ["남성", "남자", "male", "M"]:
                        metadata["성별"] = "남"
                    elif gender in ["여성", "여자", "female", "F"]:
                        metadata["성별"] = "여"
                elif isinstance(gender, list):
                    normalized = []
                    for g in gender:
                        if g in ["남성", "남자", "male", "M"]:
                            normalized.append("남")
                        elif g in ["여성", "여자", "female", "F"]:
                            normalized.append("여")
                        else:
                            normalized.append(g)
                    metadata["성별"] = normalized

            # 7. 인원수 키 정규화 (공백 제거)
            # "인원 수", " 인원수" 등 공백이 있는 키를 "인원수"로 정규화
            for key in list(metadata.keys()):
                if "인원" in key and "수" in key and key != "인원수":
                    if "인원수" not in metadata:
                        metadata["인원수"] = metadata.pop(key)
                    else:
                        metadata.pop(key)  # 중복 키 제거
            
            # 8. 인원수 정규화 (문자열을 정수로 변환)
            if "인원수" in metadata:
                count = metadata["인원수"]
                if isinstance(count, str):
                    # "10명", "10개" 등에서 숫자만 추출
                    match = re.search(r'(\d+)', count)
                    if match:
                        metadata["인원수"] = int(match.group(1))
                    else:
                        # 숫자를 찾을 수 없으면 제거
                        metadata.pop("인원수")
                elif isinstance(count, (int, float)):
                    # 이미 숫자면 정수로 변환
                    metadata["인원수"] = int(count)
                else:
                    # 다른 타입이면 제거
                    metadata.pop("인원수")
            
            extract_time = time.time() - extract_start
            return metadata

        except Exception as e:
            extract_time = time.time() - extract_start if 'extract_start' in locals() else 0
            error_msg = str(e)
            logger.error(f"[메타데이터 추출] 오류 발생: {extract_time:.2f}초, 에러: {e}", exc_info=True)
            # 인증 오류인 경우 경고만 출력하고 빈 메타데이터 반환
            if "401" in error_msg or "authentication" in error_msg.lower() or "invalid x-api-key" in error_msg.lower():
                logger.warning(f"[메타데이터 추출] Anthropic API 인증 오류: {error_msg}. 빈 메타데이터로 계속 진행")
            else:
                # 다른 오류도 경고로 처리 (검색은 계속 진행)
                logger.warning(f"[메타데이터 추출] 추출 실패 (계속 진행): {error_msg}")
            return {}

    def _normalize_job(self, job: str) -> str:
        """직업을 15개 보기 중 하나로 정규화"""
        job_lower = job.lower()
        
        # 15개 보기 매핑
        if any(kw in job_lower for kw in ["전문직", "의사", "간호사", "변호사", "회계사", "예술가", "종교인", "엔지니어", "프로그래머", "기술사"]):
            return "전문직"
        elif any(kw in job_lower for kw in ["교직", "교수", "교사", "강사"]):
            return "교직"
        elif any(kw in job_lower for kw in ["경영", "관리직", "사장", "임원", "대기업 간부", "고위 공무원"]):
            return "경영/관리직"
        elif any(kw in job_lower for kw in ["사무직", "공무원", "회사원", "직장인", "은행원", "군인", "경찰", "소방관"]):
            return "사무직"
        elif any(kw in job_lower for kw in ["자영업", "사업"]):
            return "자영업"
        elif any(kw in job_lower for kw in ["판매직", "세일즈", "보험설계사", "영업"]):
            return "판매직"
        elif any(kw in job_lower for kw in ["서비스직", "미용", "요식업"]):
            return "서비스직"
        elif any(kw in job_lower for kw in ["생산직", "노무직", "운전", "현장직"]):
            return "생산/노무직"
        elif any(kw in job_lower for kw in ["기능직", "기술직", "제빵", "목수", "전기공", "정비사", "배관공"]):
            return "기능직"
        elif any(kw in job_lower for kw in ["농업", "임업", "축산", "수산", "광업"]):
            return "농업/임업/축산업/광업/수산업"
        elif "임대" in job_lower:
            return "임대업"
        elif any(kw in job_lower for kw in ["중학생", "고등학생", "학생"]) and "대학" not in job_lower:
            return "중/고등학생"
        elif any(kw in job_lower for kw in ["대학생", "대학원생"]):
            return "대학생/대학원생"
        elif any(kw in job_lower for kw in ["주부", "전업주부"]):
            return "전업주부"
        elif any(kw in job_lower for kw in ["퇴직", "은퇴", "연금"]):
            return "퇴직/연금생활자"
        
        # 15개 보기에 해당하지 않으면 그대로 반환
        return job


